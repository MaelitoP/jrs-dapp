{"version":3,"file":"walletconnect-connector.cjs.development.js","sources":["../src/index.ts"],"sourcesContent":["import WalletConnectProvider from '@walletconnect/ethereum-provider'\nimport { IWCEthRpcConnectionOptions } from '@walletconnect/types'\nimport { AbstractConnector } from '@web3-react/abstract-connector'\nimport { ConnectorUpdate } from '@web3-react/types'\n\nexport const URI_AVAILABLE = 'URI_AVAILABLE'\n\nexport interface WalletConnectConnectorArguments extends IWCEthRpcConnectionOptions {\n  supportedChainIds?: number[]\n}\n\nexport class UserRejectedRequestError extends Error {\n  public constructor() {\n    super()\n    this.name = this.constructor.name\n    this.message = 'The user rejected the request.'\n  }\n}\n\nfunction getSupportedChains({ supportedChainIds, rpc }: WalletConnectConnectorArguments): number[] | undefined {\n  if (supportedChainIds) {\n    return supportedChainIds\n  }\n\n  return rpc ? Object.keys(rpc).map(k => Number(k)) : undefined\n}\n\nexport class WalletConnectConnector extends AbstractConnector {\n  public walletConnectProvider?: WalletConnectProvider\n  private readonly config: WalletConnectConnectorArguments\n\n  constructor(config: WalletConnectConnectorArguments) {\n    super({ supportedChainIds: getSupportedChains(config) })\n    this.config = config\n\n    this.handleChainChanged = this.handleChainChanged.bind(this)\n    this.handleAccountsChanged = this.handleAccountsChanged.bind(this)\n    this.handleDisconnect = this.handleDisconnect.bind(this)\n  }\n\n  private handleChainChanged(chainId: number | string): void {\n    if (__DEV__) {\n      console.log(\"Handling 'chainChanged' event with payload\", chainId)\n    }\n    this.emitUpdate({ chainId })\n  }\n\n  private handleAccountsChanged(accounts: string[]): void {\n    if (__DEV__) {\n      console.log(\"Handling 'accountsChanged' event with payload\", accounts)\n    }\n    this.emitUpdate({ account: accounts[0] })\n  }\n\n  private handleDisconnect(): void {\n    if (__DEV__) {\n      console.log(\"Handling 'disconnect' event\")\n    }\n    // we have to do this because of a @walletconnect/web3-provider bug\n    if (this.walletConnectProvider) {\n      this.walletConnectProvider.removeListener('chainChanged', this.handleChainChanged)\n      this.walletConnectProvider.removeListener('accountsChanged', this.handleAccountsChanged)\n      this.walletConnectProvider = undefined\n    }\n    this.emitDeactivate()\n  }\n\n  public async activate(): Promise<ConnectorUpdate> {\n    if (!this.walletConnectProvider) {\n      const WalletConnectProvider = await import('@walletconnect/ethereum-provider').then(m => m?.default ?? m)\n      this.walletConnectProvider = new WalletConnectProvider(this.config)\n    }\n\n    // ensure that the uri is going to be available, and emit an event if there's a new uri\n    if (!this.walletConnectProvider.connector.connected) {\n      await this.walletConnectProvider.connector.createSession(\n        this.config.chainId ? { chainId: this.config.chainId } : undefined\n      )\n      this.emit(URI_AVAILABLE, this.walletConnectProvider.connector.uri)\n    }\n\n    let account: string\n    account = await new Promise<string>((resolve, reject) => {\n      const userReject = () => {\n        // Erase the provider manually\n        this.walletConnectProvider = undefined\n        reject(new UserRejectedRequestError())\n      }\n\n      // Workaround to bubble up the error when user reject the connection\n      this.walletConnectProvider!.connector.on('disconnect', () => {\n        // Check provider has not been enabled to prevent this event callback from being called in the future\n        if (!account) {\n          userReject()\n        }\n      })\n\n      this.walletConnectProvider!.enable()\n        .then((accounts: string[]) => resolve(accounts[0]))\n        .catch((error: Error): void => {\n          // TODO ideally this would be a better check\n          if (error.message === 'User closed modal') {\n            userReject()\n            return\n          }\n          reject(error)\n        })\n    }).catch(err => {\n      throw err\n    })\n\n    this.walletConnectProvider.on('disconnect', this.handleDisconnect)\n    this.walletConnectProvider.on('chainChanged', this.handleChainChanged)\n    this.walletConnectProvider.on('accountsChanged', this.handleAccountsChanged)\n\n    return { provider: this.walletConnectProvider, account }\n  }\n\n  public async getProvider(): Promise<any> {\n    return this.walletConnectProvider\n  }\n\n  public async getChainId(): Promise<number | string> {\n    return Promise.resolve(this.walletConnectProvider!.chainId)\n  }\n\n  public async getAccount(): Promise<null | string> {\n    return Promise.resolve(this.walletConnectProvider!.accounts).then((accounts: string[]): string => accounts[0])\n  }\n\n  public deactivate() {\n    if (this.walletConnectProvider) {\n      this.walletConnectProvider.removeListener('disconnect', this.handleDisconnect)\n      this.walletConnectProvider.removeListener('chainChanged', this.handleChainChanged)\n      this.walletConnectProvider.removeListener('accountsChanged', this.handleAccountsChanged)\n      this.walletConnectProvider.disconnect()\n    }\n  }\n\n  public async close() {\n    this.emitDeactivate()\n  }\n}\n"],"names":["URI_AVAILABLE","UserRejectedRequestError","name","constructor","message","Error","getSupportedChains","supportedChainIds","rpc","Object","keys","map","k","Number","undefined","WalletConnectConnector","config","handleChainChanged","bind","handleAccountsChanged","handleDisconnect","chainId","console","log","emitUpdate","accounts","account","walletConnectProvider","removeListener","emitDeactivate","activate","Promise","resolve","reject","userReject","connector","on","enable","then","error","err","provider","connected","createSession","emit","uri","m","WalletConnectProvider","getProvider","getChainId","getAccount","deactivate","disconnect","close","AbstractConnector"],"mappings":"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"}